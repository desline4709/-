# <center>现代程序设计3</center>

## <center>Python包编写</center>

### 一、任务要求

- 建立包GraphStat，实现相关网络的构建和可视化。
- 其中包Graph，用以实现点和图结构的创建，以及相关的基础统计功能
	- 实现node.py模块
	- 对graph.py模块，同上，同时实现图结构的序列化存储。
	- 实现stat.py模块，基于图结构，进行基础的统计
- 包Visualization， 基于上述构建的图和节点结构，利用matplotlib等绘制相关的统计结果
    - plotgraph.py 绘制基于图的信息，如图的结构
    - plotnodes.py 绘制节点的属性分布，并提供结果保存

### 二、分文件实现
#### 1. 文件结构树
GraphStat

- \__init__.py
- GraphBuilder
    - \__init__.py
    - node,py
    - graph.py
    - stat.py
- Visualisation
    -  \__init__.py
    -  plotgraph.py
    -  plotnodes.py

#### 2. 按文件实现功能——模块化思想

##### （1）node.py

本文件主要负责进行与本地文件的交互，将本地文件转化为节点并返回、打印节点信息、打印节点指定属性等功能

```python
def init_node(path):
    """
    Return node list from node file
    :param path: file path
    :return: node list
    """
    with open(path, 'r', encoding='utf-8') as f:
        fstr = f.read()
    
    index = fstr.find('*Edges')
    fstr = fstr[:index-1]
    flist = fstr.split('\n')[1:]

    keys = ['Node Id', 'Node Name', 'Weight', 'Node Class', 'Other Info']
    NodeList =[]
    for i in range(len(flist)):
        value = flist[i].split('\t')
        node = dict(zip(keys, value))
        NodeList.append(node)
    
    return NodeList

def print_node(node):
    """
    print all the info of a node
    :Param node: a node, as a dict of attributes and its value
    :Return: None
    """
    keys = ['Node Id', 'Node Name', 'Weight', 'Node Class', 'Other Info']
    res = "{1[0]}: {0[Node Id]}\n{1[1]}: {0[Node Name]}\n{1[2]}: {0[Weight]}\n{1[3]}: {0[Node Class]}\n{1[4]}: {0[Other Info]}".format(node, keys)
    print(res)

def get_attribute(node, attr):
    """
    get attr from node
    :Param node: a node, as a dict of attributes
    :Param attr: string, node attribute
    """
    try:
        res_str = "{}: {}".format(attr, node[attr])
        print(res_str)
    except:
        print('Attr Error!')
```

初始化：![NodeList](D:\大学\大二到大四\大三上\现代程序设计\作业\week4\NodeList.png)

printnode:

![print node](D:\大学\大二到大四\大三上\现代程序设计\作业\week4\print node.png)

get attr:

![get attr](D:\大学\大二到大四\大三上\现代程序设计\作业\week4\get attr.png)

##### （2）graph.py

负责与本地文件交互构成图结构并返回，以及图结构的处理——图结构的序列化和反序列化

```python
import pickle as pkl


def init_graph(path):
    """
    return a dict of vertices and edges
    :param path: the path of graph file
    :return: a dict of vertices and edges with keys NodeList and EdgeList
    """
    with open(path, 'r', encoding='utf-8') as f:
        fstr = f.read()

    index = fstr.find('*Edge')
    ver_keys = ['Node Id', 'Node Name', 'Weight', 'Node Class', 'Other Info']
    vertices = fstr[:index - 1].split('\n')[1:]
    edges = fstr[index:].split('\n')[1:-1]
    edg_keys = ['Edge Id-1', 'Edge Id-2', 'Edge Weight']

    NodeList = []
    EdgeList = []
    for i in range(len(vertices)):
        value = vertices[i].split('\t')
        node = dict(zip(ver_keys, value))
        NodeList.append(node)
    for i in range(len(edges)):
        value = edges[i].split('\t')
        edge = dict(zip(edg_keys, value))
        EdgeList.append(edge)
    res = {'NodeList': NodeList, 'EdgeList': EdgeList}
    return res


def save_graph(filepath, graph):
    """
    save the graph
    :param filepath: path of the saving file
    :param graph:
    :return: None
    """
    with open(filepath, 'wb') as f:
        pkl.dump(graph, f)
    print('Graph Saved')


def load_graph(filepath):
    """
    load graph from savings
    :param filepath:
    :return: graph
    """
    with open(filepath, 'rb') as f:
        res = pkl.load(f)
    print('Graph Loaded')
    return res
```

init graph:

![init graph](D:\大学\大二到大四\大三上\现代程序设计\作业\week4\init graph.png)

序列化和反序列化：

![save and load](D:\大学\大二到大四\大三上\现代程序设计\作业\week4\save and load.png)

##### （3）stat.py

计算图的平均度、计算图中各个属性的分布，包括`Node Id, Node Name, Weight, Node Class,Other Info`以及`degree`的度分布

```python
def cal_average_degree(graph):
    """
    计算图的平均度
    :param graph:
    :return:
    """
    EdgeList = graph['EdgeList']
    NodeList = graph["NodeList"]
    # 总度数是边数的两倍
    degree = len(EdgeList) / 2
    res = degree / len(NodeList)
    return res

def cal_attr_distribute(graph, attr):
    """
    计算指定属性的分布
    :param graph:
    :param attr: 节点的属性'Node Id', 'Node Name', 'Weight', 'Node Class', 'Other Info'以及度 'degre'
    :return:
    """
    NodeList = graph['NodeList']
    EdgeList = graph['EdgeList']
    attr_num = {}
    if attr != 'degree':
        for i in NodeList:
            if i[attr] not in attr_num:
                attr_num[i[attr]] = 1
            else:
                attr_num[i[attr]] += 1
    else:
        # 计算度分布
        node_num = len(NodeList)
        keys = [str(i) for i in range(node_num)]
        attr_num = attr_num.fromkeys(keys, 0)
        # print(attr_num)
        for i in EdgeList:
            attr_num[i['Edge Id-1']] +=1
            attr_num[i['Edge Id-2']] +=1
    return attr_num
```

平均度：

![平均度](D:\大学\大二到大四\大三上\现代程序设计\作业\week4\平均度.png)

属性分布：

![属性分布](D:\大学\大二到大四\大三上\现代程序设计\作业\week4\属性分布.png)

##### （4）plotgraph.py

处理图结构的画图包，主要画出度分布

```python
import matplotlib.pyplot as plt
import numpy as np
from GraphStat.GraphBuilder import stat

def plot_degree_distribution(graph):
    """
    画出度分布
    :param graph:
    """
    NodeList = graph['NodeList']
    node_dict = stat.cal_attr_distribute(graph, 'degree')
    # node_num = len(NodeList)
    # edge_num_fullconnected = int(node_num * (node_num-1) /2)
    # edge_keys = [i for i in range(edge_num_fullconnected)]
    dis_dict = {}
    for i in node_dict:
        if node_dict[i] not in dis_dict:
            dis_dict[node_dict[i]] = 1
        else:
            dis_dict[node_dict[i]] +=1
    dis_dict = dict(sorted(dis_dict.items(), key=lambda item:item[1], reverse=True))

    dict_num = len(dis_dict)
    x = np.arange(dict_num)
    y = list(dis_dict.values())
    labels = [str(i) for i in dis_dict]
    bar_width = 0.5
    plt.figure(0,figsize=(80,10),dpi=300)
    plt.bar(x, y, bar_width)
    plt.xticks(x, labels)
    for i in range(len(x)):
        plt.text(x[i]-0.35,y[i]+0.5,str(y[i]), fontsize = 6)
    plt.title('节点度分布', fontfamily='SimHei', fontsize = 15)
    plt.xlabel('节点度数', fontfamily='SimHei', fontsize = 15)
    plt.ylabel('频数', fontfamily='SimHei', fontsize = 15)
    plt.savefig('度分布.png')
    plt.show()
```

![度分布](D:\大学\大二到大四\大三上\现代程序设计\作业\week4\度分布.png)

##### （5）plotnodes.py

处理图结构中节点的画图包，主要画出节点指定属性的分布图

```python
import matplotlib.pyplot as plt
from GraphStat.GraphBuilder import stat
import numpy as np

def plot_nodes_attr(graph, feature):
    """
    画出图的制定属性的分布
    :param graph:
    :param feature:
    :return:
    """
    attr_num_dict = stat.cal_attr_distribute(graph, feature)
    num = len(attr_num_dict)
    x = np.arange(num)
    y = list(attr_num_dict.values())
    labels = list(attr_num_dict.keys())
    plt.figure()
    bar_width = 0.5
    plt.bar(x, y, bar_width)
    plt.xticks(x, labels)
    plt.title("{}的分布图".format(feature), fontfamily = 'SimHei')
    for i in range(num):
        plt.text(x[i]-0.15, y[i]+0.5, str(y[i]))
    plt.savefig("{}的分布图".format(feature))
    plt.show()
```

![Node Class的分布图](D:\大学\大二到大四\大三上\现代程序设计\作业\week4\Node Class的分布图.png)

##### （6）main.py 调试工程

```python
from GraphStat.GraphBuilder import node as nd
from GraphStat.GraphBuilder import graph as gh
from GraphStat.GraphBuilder import stat
from GraphStat.Visualization import plotgraph
from GraphStat.Visualization import plotnodes

NodeList = nd.init_node('newmovies.txt')
# print(NodeList)
# nd.print_node(NodeList[-1])
# x = nd.get_attribute(NodeList[0], 'Node Name')

Graph = gh.init_graph('newmovies.txt')
# print(Graph['EdgeList'][-1])
# gh.save_graph('graph1.txt', Graph)
# Graph1 = gh.load_graph('graph1.txt')
# print(Graph1['NodeList'][-1])
# x = stat.cal_average_degree(Graph)
# print(x)
# res = stat.cal_attr_distribute(Graph, 'Node Class')
# print(res)
# plotgraph.plot_degree_distribution(Graph)
# plotnodes.plot_nodes_attr(Graph, "Node Class")
```

